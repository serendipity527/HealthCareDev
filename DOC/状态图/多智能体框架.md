```mermaid
graph TD
    %% å®šä¹‰æ ·å¼
    classDef user fill:#e1f5fe,stroke:#01579b,stroke-width:2px,rx:10px,ry:10px,color:#000;
    classDef guard fill:#ffebee,stroke:#b71c1c,stroke-width:2px,rx:5px,ry:5px,color:#000;
    classDef orchestrator fill:#e8eaf6,stroke:#1a237e,stroke-width:2px,rx:5px,ry:5px,color:#000;
    classDef agent fill:#f3e5f5,stroke:#4a148c,stroke-width:2px,rx:5px,ry:5px,stroke-dasharray: 5 5,color:#000;
    classDef rag fill:#fff3e0,stroke:#e65100,stroke-width:2px,rx:0px,ry:0px,color:#000;
    classDef output fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px,rx:5px,ry:5px,color:#000;

    %% å¼€å§‹èŠ‚ç‚¹
    Start([ğŸš€ å¼€å§‹ä¼šè¯]) --> UserInput

    %% ç”¨æˆ·è¾“å…¥å±‚
    subgraph Interface [äº¤äº’å±‚]
        UserInput[ğŸ—£ï¸ ç”¨æˆ·/ç—…äººè¾“å…¥]:::user
        ResponseGen[ğŸ’¬ å“åº”ç”Ÿæˆå™¨<br>Doctor Persona]:::output
    end

    UserInput --> SafetyGuard

    %% å®‰å…¨ä¸åˆ†è¯Šå±‚
    subgraph Triage [é¢„æ£€åˆ†è¯Šå±‚]
        SafetyGuard{ğŸ›¡ï¸ å®‰å…¨æŠ¤æ /åˆè§„æ£€æŸ¥<br>æ˜¯å¦ç´§æ€¥æƒ…å†µ?}:::guard
        Emergency[ğŸš¨ ç´§æ€¥é¢„æ¡ˆè§¦å‘<br>å»ºè®®ç«‹å³å°±åŒ»]:::guard
    end

    SafetyGuard -- æ˜¯: ç´§æ€¥ --> Emergency
    SafetyGuard -- å¦: å®‰å…¨ --> StateManager

    %% æ ¸å¿ƒç¼–æ’å±‚
    subgraph Core [æ ¸å¿ƒç¼–æ’å±‚]
        StateManager{ğŸ§  çŠ¶æ€ç®¡ç†å™¨/è·¯ç”±<br>Orchestrator}:::orchestrator
        PatientState[(ğŸ—‚ï¸ ç—…äººä¿¡æ¯çŠ¶æ€æ§½<br>ç›®å‰æ”¶é›†åˆ°çš„ç—‡çŠ¶)]:::rag
    end

    StateManager <--> PatientState

    %% æ™ºèƒ½ä½“å·¥ä½œå±‚
    subgraph Agents [ä¸“ä¸šæ™ºèƒ½ä½“å±‚]
        NLU_Agent[ğŸ§© ç—‡çŠ¶æå–æ™ºèƒ½ä½“<br>NER/å®ä½“è¯†åˆ«]:::agent
        History_Agent[ğŸ“‹ é—®è¯Šæ™ºèƒ½ä½“<br>è¿½é—®ç—‡çŠ¶ç»†èŠ‚ OLD CARTS]:::agent
        Diagnostic_Agent[ğŸ©º è¯Šæ–­åˆ†ææ™ºèƒ½ä½“<br>é‰´åˆ«è¯Šæ–­/æ¨ç†]:::agent
    end
    
    %% çŸ¥è¯†åº“å±‚
    subgraph Knowledge [çŸ¥è¯†æ”¯æŒå±‚]
        MedicalKB[ğŸ“š åŒ»ç–—çŸ¥è¯†åº“ RAG<br>åŒ»å­¦æŒ‡å—/ç—…ä¾‹åº“]:::rag
    end

    %% è·¯ç”±é€»è¾‘
    StateManager -- 1. æ–°è¾“å…¥åˆ†æ --> NLU_Agent
    NLU_Agent --> StateManager
    
    StateManager -- 2. ä¿¡æ¯ä¸å®Œæ•´ --> History_Agent
    History_Agent -- éœ€è¦ä¸“ä¸šçŸ¥è¯† --> MedicalKB
    MedicalKB --> History_Agent
    History_Agent --> StateManager

    StateManager -- 3. ä¿¡æ¯å……è¶³ --> Diagnostic_Agent
    Diagnostic_Agent -- æŸ¥è¯¢ç±»ä¼¼ç—…ä¾‹ --> MedicalKB
    MedicalKB --> Diagnostic_Agent
    Diagnostic_Agent --> StateManager

    %% è¾“å‡ºé€»è¾‘
    StateManager -- ç”Ÿæˆå›å¤ --> ResponseGen
    Emergency --> ResponseGen
    ResponseGen --> UserWait([â³ ç­‰å¾…ç”¨æˆ·å›å¤])
    UserWait --> UserInput

    %% è¿æ¥æ³¨é‡Š
    linkStyle default stroke-width:2px,fill:none,stroke:black;

```