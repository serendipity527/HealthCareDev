<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket ç‚¹å¯¹ç‚¹é€šä¿¡æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }

        .input-group input,
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-group input:focus,
        .input-group textarea:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-connect {
            background: #28a745;
            color: white;
        }

        .btn-connect:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-disconnect {
            background: #dc3545;
            color: white;
        }

        .btn-disconnect:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }

        .btn-send {
            background: #667eea;
            color: white;
        }

        .btn-send:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-send:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .messages {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-height: 500px;
            overflow-y: auto;
        }

        .messages h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .message-item {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            background: #f8f9fa;
        }

        .message-item.private {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        .message-time {
            color: #666;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .message-content {
            color: #333;
            word-wrap: break-word;
        }

        .message-meta {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
            font-style: italic;
        }

        .clear-btn {
            background: #6c757d;
            color: white;
            padding: 8px 15px;
            width: auto;
            float: right;
            margin-top: 0;
            margin-bottom: 15px;
        }

        .clear-btn:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”Œ WebSocket ç‚¹å¯¹ç‚¹é€šä¿¡æµ‹è¯•å¹³å°</h1>

        <div class="cards-container">
            <!-- è¿æ¥æ§åˆ¶å¡ç‰‡ -->
            <div class="card">
                <h2>ğŸ“¡ è¿æ¥æ§åˆ¶</h2>
                <div id="status" class="status disconnected">æœªè¿æ¥</div>
                <div class="input-group">
                    <label for="username">ç”¨æˆ·å</label>
                    <input type="text" id="username" placeholder="è¯·è¾“å…¥æ‚¨çš„ç”¨æˆ·å" value="å¼ ä¸‰">
                </div>
                <button id="connectBtn" class="btn-connect" onclick="connect()">è¿æ¥</button>
                <button id="disconnectBtn" class="btn-disconnect" onclick="disconnect()" style="display:none;">æ–­å¼€è¿æ¥</button>
            </div>

            <!-- ç‚¹å¯¹ç‚¹æ¶ˆæ¯å¡ç‰‡ -->
            <div class="card">
                <h2>ğŸ’¬ ç‚¹å¯¹ç‚¹æ¶ˆæ¯</h2>
                <div class="input-group">
                    <label for="receiver">æ¥æ”¶è€…ç”¨æˆ·å</label>
                    <input type="text" id="receiver" placeholder="è¯·è¾“å…¥æ¥æ”¶è€…ç”¨æˆ·å" value="æå››">
                </div>
                <div class="input-group">
                    <label for="privateMessage">æ¶ˆæ¯å†…å®¹</label>
                    <textarea id="privateMessage" placeholder="è¾“å…¥ç§ä¿¡å†…å®¹...">ä½ å¥½ï¼Œæå››ï¼</textarea>
                </div>
                <div class="input-group">
                    <label for="privateType">æ¶ˆæ¯ç±»å‹</label>
                    <select id="privateType">
                        <option value="CHAT">èŠå¤©</option>
                        <option value="SYSTEM">ç³»ç»Ÿ</option>
                    </select>
                </div>
                <button id="sendPrivateBtn" class="btn-send" onclick="sendPrivate()" disabled>å‘é€ç§ä¿¡</button>
            </div>
        </div>

        <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="messages">
            <h2>ğŸ“¨ æ¶ˆæ¯è®°å½•</h2>
            <button class="clear-btn" onclick="clearMessages()">æ¸…ç©ºæ¶ˆæ¯</button>
            <div style="clear: both;"></div>
            <div id="messageList"></div>
        </div>
    </div>

    <script>
        let stompClient = null;
        let currentUsername = '';

        // è¿æ¥WebSocket
        function connect() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                alert('è¯·è¾“å…¥ç”¨æˆ·åï¼');
                return;
            }

            currentUsername = username;
            
            // ä½¿ç”¨SockJSè¿æ¥ï¼ˆä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œç¡®ä¿è¿æ¥åˆ°æ­£ç¡®çš„æœåŠ¡å™¨ï¼‰
            const socket = new SockJS('http://localhost:8080/websocket');
            stompClient = Stomp.over(socket);

            // è¿æ¥åˆ°æœåŠ¡å™¨
            stompClient.connect({}, function(frame) {
                console.log('è¿æ¥æˆåŠŸ: ' + frame);
                updateStatus(true);

                // è®¢é˜…ç‚¹å¯¹ç‚¹æ¶ˆæ¯
                stompClient.subscribe('/user/queue/messages', function(message) {
                    try {
                        console.log('æ”¶åˆ°ç§ä¿¡ï¼ˆåŸå§‹ï¼‰:', message);
                        console.log('æ¶ˆæ¯ä½“ï¼ˆJSONå­—ç¬¦ä¸²ï¼‰:', message.body);
                        const msg = JSON.parse(message.body);
                        console.log('è§£æåçš„æ¶ˆæ¯å¯¹è±¡:', msg);
                        displayMessage(msg, 'private', 'ğŸ’¬ ç§ä¿¡');
                    } catch (error) {
                        console.error('è§£æç§ä¿¡å¤±è´¥:', error);
                        addSystemMessage('âŒ æ¶ˆæ¯è§£æå¤±è´¥: ' + error.message);
                    }
                });

                addSystemMessage('âœ… è¿æ¥æˆåŠŸï¼ç”¨æˆ·å: ' + username);
            }, function(error) {
                console.error('è¿æ¥å¤±è´¥: ' + error);
                updateStatus(false);
                addSystemMessage('âŒ è¿æ¥å¤±è´¥: ' + error);
            });
        }

        // æ–­å¼€è¿æ¥
        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
            }
            updateStatus(false);
            addSystemMessage('ğŸ”Œ å·²æ–­å¼€è¿æ¥');
        }

        // å‘é€ç‚¹å¯¹ç‚¹æ¶ˆæ¯
        function sendPrivate() {
            const content = document.getElementById('privateMessage').value.trim();
            const receiver = document.getElementById('receiver').value.trim();
            const type = document.getElementById('privateType').value;

            if (!content) {
                alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹ï¼');
                return;
            }

            if (!receiver) {
                alert('è¯·è¾“å…¥æ¥æ”¶è€…ç”¨æˆ·åï¼');
                return;
            }

            const message = {
                content: content,
                sender: currentUsername,
                receiver: receiver,
                type: type
            };

            stompClient.send('/app/send/to/user', {}, JSON.stringify(message));
            console.log('å‘é€ç§ä¿¡:', message);
            addSystemMessage('ğŸ“¤ å·²å‘é€ç§ä¿¡ç»™ ' + receiver);
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function displayMessage(message, messageType, typeLabel) {
            console.log('å‡†å¤‡æ˜¾ç¤ºæ¶ˆæ¯:', message);
            
            const messageList = document.getElementById('messageList');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-item ' + messageType;

            // æ ¼å¼åŒ–æ—¶é—´æˆ³
            let time;
            if (message.timestamp) {
                // å¦‚æœæ˜¯ ISO 8601 æ ¼å¼ï¼Œè½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´
                try {
                    const date = new Date(message.timestamp);
                    time = date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                } catch (e) {
                    time = message.timestamp;
                }
            } else {
                time = new Date().toLocaleString('zh-CN');
            }
            
            messageDiv.innerHTML = `
                <div class="message-time">${time} - ${typeLabel}</div>
                <div class="message-content"><strong>${message.sender || 'åŒ¿å'}:</strong> ${message.content}</div>
                <div class="message-meta">ç±»å‹: ${message.type}${message.receiver ? ' | æ¥æ”¶è€…: ' + message.receiver : ''}</div>
            `;

            messageList.insertBefore(messageDiv, messageList.firstChild);
            console.log('æ¶ˆæ¯å·²æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š');
        }

        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        function addSystemMessage(content) {
            const messageList = document.getElementById('messageList');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-item';
            messageDiv.innerHTML = `
                <div class="message-time">${new Date().toLocaleString('zh-CN')}</div>
                <div class="message-content">${content}</div>
            `;
            messageList.insertBefore(messageDiv, messageList.firstChild);
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateStatus(connected) {
            const statusDiv = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const sendPrivateBtn = document.getElementById('sendPrivateBtn');

            if (connected) {
                statusDiv.textContent = 'âœ… å·²è¿æ¥';
                statusDiv.className = 'status connected';
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'block';
                sendPrivateBtn.disabled = false;
            } else {
                statusDiv.textContent = 'âŒ æœªè¿æ¥';
                statusDiv.className = 'status disconnected';
                connectBtn.style.display = 'block';
                disconnectBtn.style.display = 'none';
                sendPrivateBtn.disabled = true;
            }
        }

        // æ¸…ç©ºæ¶ˆæ¯
        function clearMessages() {
            document.getElementById('messageList').innerHTML = '';
        }

        // é¡µé¢å¸è½½æ—¶æ–­å¼€è¿æ¥
        window.onbeforeunload = function() {
            if (stompClient !== null) {
                stompClient.disconnect();
            }
        };
    </script>
</body>
</html>

